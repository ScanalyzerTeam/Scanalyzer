name: Discord Notifications

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, closed, reopened]

jobs:
  notify-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord push notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1 | sed 's/"/\\"/g')
          COMMIT_URL="${{ github.event.head_commit.url }}"
          BRANCH="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          curl -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"üöÄ New Push to ${BRANCH}\",
              \"color\": 5814783,
              \"fields\": [
                {\"name\": \"Repository\", \"value\": \"${REPO}\", \"inline\": true},
                {\"name\": \"Branch\", \"value\": \"${BRANCH}\", \"inline\": true},
                {\"name\": \"Author\", \"value\": \"${AUTHOR}\", \"inline\": true},
                {\"name\": \"Commit\", \"value\": \"[\`${COMMIT_SHA}\`](${COMMIT_URL})\", \"inline\": true},
                {\"name\": \"Message\", \"value\": \"${COMMIT_MSG}\", \"inline\": false}
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" \
          $DISCORD_WEBHOOK

  notify-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord PR notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          PR_TITLE=$(echo "${{ github.event.pull_request.title }}" | sed 's/"/\\"/g')
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_ACTION="${{ github.event.action }}"
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          REPO="${{ github.repository }}"

          if [ "$PR_ACTION" == "opened" ]; then
            EMOJI="üì¨"
            COLOR=3447003
            ACTION_TEXT="Opened"
          elif [ "$PR_ACTION" == "closed" ] && [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            EMOJI="üéâ"
            COLOR=5763719
            ACTION_TEXT="Merged"
          elif [ "$PR_ACTION" == "closed" ]; then
            EMOJI="‚ùå"
            COLOR=15548997
            ACTION_TEXT="Closed"
          else
            EMOJI="üîÑ"
            COLOR=16776960
            ACTION_TEXT="Reopened"
          fi

          curl -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"${EMOJI} Pull Request ${ACTION_TEXT}: #${PR_NUMBER}\",
              \"url\": \"${PR_URL}\",
              \"color\": ${COLOR},
              \"fields\": [
                {\"name\": \"Repository\", \"value\": \"${REPO}\", \"inline\": true},
                {\"name\": \"Author\", \"value\": \"${PR_AUTHOR}\", \"inline\": true},
                {\"name\": \"Branch\", \"value\": \"${HEAD_BRANCH} ‚Üí ${BASE_BRANCH}\", \"inline\": true},
                {\"name\": \"Title\", \"value\": \"${PR_TITLE}\", \"inline\": false}
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" \
          $DISCORD_WEBHOOK
