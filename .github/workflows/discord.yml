name: Discord Notifications

on:
  push:
    branches: [main, develop]

  pull_request:
    types: [opened, closed, reopened]

jobs:
  notify-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord push notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Extract commit info
          COMMIT_MESSAGE=$(echo '${{ github.event.head_commit.message }}' | head -1 | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          COMMIT_URL="${{ github.event.head_commit.url }}"
          BRANCH="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Create JSON payload with embed
          cat > payload.json << 'PAYLOAD_END'
          {
            "embeds": [{
              "title": "ðŸš€ New Push to BRANCH_PLACEHOLDER",
              "color": 5814783,
              "fields": [
                {"name": "Repository", "value": "REPO_PLACEHOLDER", "inline": true},
                {"name": "Branch", "value": "BRANCH_PLACEHOLDER", "inline": true},
                {"name": "Author", "value": "AUTHOR_PLACEHOLDER", "inline": true},
                {"name": "Commit", "value": "[`COMMIT_SHA_PLACEHOLDER`](COMMIT_URL_PLACEHOLDER)", "inline": true},
                {"name": "Message", "value": "COMMIT_MESSAGE_PLACEHOLDER", "inline": false}
              ],
              "timestamp": "TIMESTAMP_PLACEHOLDER"
            }]
          }
          PAYLOAD_END

          # Replace placeholders
          sed -i "s|REPO_PLACEHOLDER|${REPO}|g" payload.json
          sed -i "s|BRANCH_PLACEHOLDER|${BRANCH}|g" payload.json
          sed -i "s|AUTHOR_PLACEHOLDER|${AUTHOR}|g" payload.json
          sed -i "s|COMMIT_SHA_PLACEHOLDER|${COMMIT_SHA}|g" payload.json
          sed -i "s|COMMIT_URL_PLACEHOLDER|${COMMIT_URL}|g" payload.json
          sed -i "s|COMMIT_MESSAGE_PLACEHOLDER|${COMMIT_MESSAGE}|g" payload.json
          sed -i "s|TIMESTAMP_PLACEHOLDER|${TIMESTAMP}|g" payload.json

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d @payload.json \
               "$DISCORD_WEBHOOK"

  notify-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord PR notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Extract PR info
          PR_TITLE=$(echo '${{ github.event.pull_request.title }}' | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_ACTION="${{ github.event.action }}"
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          REPO="${{ github.repository }}"
          MERGED="${{ github.event.pull_request.merged }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Determine action text and color
          if [ "$PR_ACTION" = "opened" ]; then
            EMOJI="ðŸ“¬"
            COLOR=3447003
            ACTION_TEXT="Opened"
          elif [ "$PR_ACTION" = "closed" ] && [ "$MERGED" = "true" ]; then
            EMOJI="ðŸŽ‰"
            COLOR=5763719
            ACTION_TEXT="Merged"
          elif [ "$PR_ACTION" = "closed" ]; then
            EMOJI="âŒ"
            COLOR=15548997
            ACTION_TEXT="Closed"
          else
            EMOJI="ðŸ”„"
            COLOR=16776960
            ACTION_TEXT="Reopened"
          fi

          # Create JSON payload with embed
          cat > payload.json << PAYLOAD_END
          {
            "embeds": [{
              "title": "${EMOJI} Pull Request ${ACTION_TEXT}: #${PR_NUMBER}",
              "url": "${PR_URL}",
              "color": ${COLOR},
              "fields": [
                {"name": "Repository", "value": "${REPO}", "inline": true},
                {"name": "Author", "value": "${PR_AUTHOR}", "inline": true},
                {"name": "Branch", "value": "${HEAD_BRANCH} â†’ ${BASE_BRANCH}", "inline": true},
                {"name": "Title", "value": "${PR_TITLE}", "inline": false}
              ],
              "timestamp": "${TIMESTAMP}"
            }]
          }
          PAYLOAD_END

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d @payload.json \
               "$DISCORD_WEBHOOK"
